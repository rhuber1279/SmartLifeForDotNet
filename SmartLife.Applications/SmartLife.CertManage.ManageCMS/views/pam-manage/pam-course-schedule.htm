<style type="text/css">
    .livecourse-block{min-height:60px;height:auto;margin:0 auto;}
    .livecourse-title{height:30px; line-height:30px; margin:5px 0 0 0 ; padding:2px; text-align:left; background-color:#87CEFF; font-size:16px;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;}

    .livecourse-mot{width:200px; height:205px;margin:5px; float:left;text-align:center; border:solid 1px #006699;  -moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px; }
    .livecourse-mot-head{width:100%;color:White; cursor:pointer; text-indent:2px; line-height:25px; height:25px; background-color:#006699; text-align:center; }
    .livecourse-mot-body{width:100%;height:155px; color:white; background-color:#006030; }
    .livecourse-mot-foot{width:97%;color:#000; text-indent:5px;  height:24px; line-height:24px; position:relative; margin:0px 3px; }
    
    .alink { z-index:201; cursor:pointer;display:none;}
</style>
<div id="toolbar-CourseSchedule" >
    <table width="100%;"  height="60px">
        <tr>
            <td id="CurrentAgencys-cc" style="text-align: left; width: 200px; border-right:1px solid #ddd; padding-left:5px; padding-right:5px;">
                <div id="CurrentAgencys-c" style="display: inline-block;"><input id="CurrentAgencys" /></div> 
            </td>
            <td style="text-align: left;">
            <table>
                <tr>
                    <td style=" border-right:1px solid #ddd; padding-left:5px; padding-right:5px;">
                        从<input id="ScheduleOn_Start" name="ScheduleOn_Start" class="Wdate" onfocus="WdatePicker({isShowClear:false})" style="width: 90px; border-left: none; border-right: none; border-top: none;" />
                        至<input id="ScheduleOn_End" name="ScheduleOn_End" class="Wdate" onfocus="WdatePicker({isShowClear:false})" style="width: 90px; border-left: none; border-right: none; border-top: none;" />
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-prev" plain="true" onclick="queryLastWeek()">上周</a> 
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-next" plain="true" onclick="queryNextWeek()">下周</a>
                    </td>
                    <td >
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="queryData()">查询</a>
                    </td>
                </tr>
            </table>
            </td>
        </tr>
        <tr>
            <td style=" text-align:left;">
                <div id="BatchScheduleInfo" style=" float:left;width:80%; margin-left:6px; line-height:20px; height:20px; border-bottom:1px solid grey;" onclick="openVideoInfo('batch')"></div>
                <div style=" width:9%; float:left;">
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="openVideoInfo('batch')"></a>
                </div>
            </td>
            <td style="text-align: left;">&nbsp;
                从<input id="ReserveFrom" type="text" class="Wdate" onfocus="WdatePicker({isShowClear:false,readOnly:true,dateFmt: 'HH:mm:ss', minDate: '00:00:00', maxDate: '23:59:59' })" style="width: 90px; border-left: none; border-right: none; border-top: none;"/>
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true" onclick="reserve()">预约</a> 
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true" onclick="undo()">还原</a> 
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="updateToDB()">保存</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true" onclick="CopyCourseSchedule()">复制课程</a> 
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-loud" plain="true" onclick="PushCourseSchedule()">推送</a>
            </td>
        </tr>
    </table>
</div>
<table id="dg-B132002" class="main-area">
</table>

<div id="dlg-B132002A" class="easyui-dialog" style="width: 420px; height: 450px; padding: 10px;"
    closed="true"  cache="false" buttons="#btn-B132002A" >
    <form id="fm-B132002A" method="post" novalidate>
    <input id="ScheduleId-B132002A" name="ScheduleId" type="hidden"/>
    <input name="CourseFlag" type="hidden" />
    <div class="fitem"><label>选择课程:</label></div>
    <div class="fitem">
    <div id="SingleScheduleInfo" style="float:left;width:84%; margin-left:6px; line-height:20px; height:20px; border-bottom:1px solid grey;" onclick="openVideoInfo('single')"></div> 
    <div style=" width:9%; float:left;">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="openVideoInfo('single')"></a>
    </div>
    <div class="fitem">
        <div style=" height:155px; width:50%; text-align:center; margin-left:6px;">
            <img style=" height:100%; width:100%" id="dlgShowImg" alt="无" src="" />
        </div>
    </div>
    <input name="CourseId" type="hidden"/>
    <input name="CourseName" type="hidden"/>
    <input name="CourseDuration" type="hidden"/>
    <input name="CourseInfo" type="hidden"/>
    </div>
    <div class="fitem">
    <label>开始时间:</label> 
    <input id="SingleBeginTime" name="BeginTime" type="text" class="Wdate" onfocus="WdatePicker({isShowClear:false,readOnly:true,dateFmt: 'HH:mm:ss', minDate: '00:00:00', maxDate: '23:59:59' })" style="width: 90px; border-left: none; border-right: none; border-top: none;"/>
    </div>
    <div class="fitem">
    <label>课程备注:</label> 
    <textarea id="Remark" name="Remark" rows="3" style="width: 290px;" ></textarea>
    </div>
    <div id='div_tip' class="fitem"  style=" text-align:center;" ><span id="addHtml"></span></div>
    </form>
</div>
<div id="btn-B132002A">
     <a href="javascript:void(0)" id="btnEditScheduleOk" class="easyui-linkbutton" iconcls="icon-ok" onclick="editScheduleOK()">确定</a> 
     <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="editScheduleCancel()">关闭</a> 
</div>

<div id="toolbar-B132002AA">
    <table>
        <tr>
            <td style="width:300px; text-align:center;">
                课程类型：<input id="cbxVideoType" />
            </td>
            <td >
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="dlgVideoSearch()">查询</a>
            </td>
        </tr>
    </table>
</div>
<div id="dlg-B132002AA" class="easyui-dialog" style="width: 900px; height: 600px; padding: 5px;"
    closed="true" cache="false" buttons="#btn-B132002AA" >
    <div id="video-content" style=" height:100%; width:100%;"></div>
</div>
<div id="btn-B132002AA">
     <a href="javascript:void(0)" id="btnVideoOk" class="easyui-linkbutton" iconcls="icon-ok" onclick="dlgVideoOk()">确定</a> 
     <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="dlgVideoCancel()">关闭</a> 
</div>


<div id="dlg-CopyCourseSchedule" class="easyui-dialog" style="width: 450px; height: 400px; padding: 10px;"
    closed="true"  cache="false" buttons="#btn-CopyCourseSchedule" >
    <div style=" width:100%; height:24px; line-height:24px; margin:3px;">
        起 始 段 ：
        从<input disabled="disabled" id="CopyFrom_Start" name="CopyFrom_Start" class="Wdate" onfocus="WdatePicker({isShowClear:false,onpicked:function(){CopyFrom_End.focus();}})" style="width: 90px; border-left: none; border-right: none; border-top: none;"   />
        至<input disabled="disabled" id="CopyFrom_End" name="CopyFrom_End" class="Wdate" onfocus="WdatePicker({isShowClear:false,minDate:'#F{$dp.$D(\'CopyFrom_Start\',{d:0})}',maxDate:'#F{$dp.$D(\'CopyFrom_Start\',{d:6})}'})" style="width: 90px; border-left: none; border-right: none; border-top: none;" />
        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-prev" plain="true" onclick="moveWeek('CopyFrom','Prev')">上周</a> 
        <a href="javascript:void(0)" id='copyNextWeek' class="easyui-linkbutton" iconcls="icon-next" plain="true" onclick="moveWeek('CopyFrom','Next')">下周</a>
    </div>
    <div style=" width:100%; height:24px; line-height:24px; margin:5px;">
        目 标 段：
        从<input disabled="disabled" id="CopyTo_Start" name="CopyTo_Start" class="Wdate" onfocus="WdatePicker({isShowClear:false,onpicked:function(){CopyTo_End.focus();},minDate:'#F{$dp.$D(\'CopyFrom_Start\',{d:7})}'})" style="width: 90px; border-left: none; border-right: none; border-top: none;" />
        至<input disabled="disabled" id="CopyTo_End" name="CopyTo_End" class="Wdate" onfocus="WdatePicker({isShowClear:false,minDate:'#F{$dp.$D(\'CopyTo_Start\',{d:0})}',maxDate:'#F{$dp.$D(\'CopyFrom_Start\',{d:13})}'})" style="width: 90px; border-left: none; border-right: none; border-top: none;" />
        <a href="javascript:void(0)" class="easyui-linkbutton" id='copyLastWeek' iconcls="icon-prev"   plain="true" onclick="moveWeek('CopyTo','Prev')">上周</a> 
        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-next" plain="true" onclick="moveWeek('CopyTo','Next')">下周</a>
    </div>
    <div style=" width:100%; height:220px; overflow:auto;border-top:1px solid green;">
        <table style=" margin:5px; width:95%;">
            <tr style=" height:30px;">
                <td style="text-align:left; width:5%;"><input type="checkbox" id="checkCopyDeviceAll" onclick="checkAll(this,'copyDeviceIdList')"/></td>
                <td style="text-align:left; width:35%;"><label for="checkCopyDeviceAll">全选</label></td>
                <td style="font-size:18px; text-align:left;width:60%;">选择设备</td>
            </tr>
        </table>
        <table id="copyDeviceIdList" style=" margin:5px; width:95%;" >
        </table>
    </div>
</div>
<div id="btn-CopyCourseSchedule">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="dlgCopyOK()">保存</a> 
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="dlgCopyCancel()">关闭</a>
</div>

<div id="dlg-PushCourseSchedule" class="easyui-dialog" style="width: 450px; height: 400px; padding: 10px;"
    closed="true"  cache="false" buttons="#btn-PushCourseSchedule" >
    <div style=" width:100%; height:24px; line-height:24px; margin:3px;">
        起始时间：<input id="PushDate_Start" name="PushDate_Start" class="Wdate" onfocus="WdatePicker({minDate:'%y-%M-#{%d}'})" style="width: 90px; border-left: none; border-right: none; border-top: none;"   />&nbsp;&nbsp;&nbsp;&nbsp;
        结束时间：<input id="PushDate_End" name="PushDate_End" class="Wdate" onfocus="WdatePicker({minDate:'#F{$dp.$D(\'PushDate_Start\',{d:1})}'})" style="width: 90px; border-left: none; border-right: none; border-top: none;" />
    </div>
    <div style=" width:100%; height:250px; overflow:auto; border-top:1px solid green;">
        <table style=" margin:5px; width:95%;">
            <tr style=" height:30px;">
                <td style="text-align:left; width:5%;"><input type="checkbox" id="checkPushDeviceAll" onclick="checkAll(this,'pushDeviceIdList')"/></td>
                <td style="text-align:left; width:35%;"><label for="checkPushDeviceAll">全选</label></td>
                <td style="font-size:18px; text-align:left;width:60%;">选择设备</td>
            </tr>
        </table>
        <table id="pushDeviceIdList" style=" margin:5px; width:95%;" >
        </table>
    </div>
</div>
<div id="btn-PushCourseSchedule">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="dlgPushOK()">推送</a> 
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="dlgPushCancel()">取消</a>
</div>

<script type="text/javascript">
    placeholder(); //占位符初始化  

    var mouseClickDown = false;
    var templateOfCourseInfoForView = '<li class="serve-info-item" scheduleId="[ScheduleId]" reserveDate="[ReserveDate]" deviceId="[DeviceId]" color="[Color]"  doneStr="播放时间：[PlayStatus]" scheduleInfo="[ScheduleInfo]" ><a style="display:[DisplayStyleOfRemoveServeInfoItem]" title="删除此项" onclick="removeScheduleItem(this)" class="removeServeInfoItem actionServeInfoItem nicon-blue nicon-R2C13"></a><span onclick="[ItemClickFunc]"  title="播放时间：[PlayStatus]--[BeginTime]-[EndTime]" class="serve-info-item-fromto[Color]" >[[BeginTime]] </span><span onclick="[ItemClickFunc]" title="播放时间：[PlayStatus]--课程名：[CourseName] 时长：[[Duration]秒]" class="serve-info-item-serveman[Color]">[[CourseName]] [[Duration]S]</span><span title="播放时间：[PlayStatus]--课程名：[CourseName] 时长：[[Duration]秒]" class="serve-info-item-serveman[Color]">[[CourseTypeName]]</span><div onclick="[ItemClickFunc]" class="serve-info-item-description">[Remark]</div></li>';
    var daysBeforehand = -1; //今天之前的不能修改

    $(function () {
        autosize('dg-B132002', -64);

        loadfiles([
            { type: "css", url: "../../css/mer/staff-schedule.css" }
            ], function () {
                //加载日照
                $('#CurrentAgencys').combobox({
                    width: 180,
                    panelWidth: 300,
                    data: top.gUserInfo.MappingAgencys,
                    valueField: 'StationId',
                    textField: 'StationName',
                    editable: false,
                    onLoadSuccess: function () {
                        if (top.gUserInfo.MappingAgencys.length > 0) {
                            $('#CurrentAgencys').combobox('setValue', top.gUserInfo.MappingAgencys[0].StationId);

                            if (top.gUserInfo.MappingAgencys.length == 1) {
                                $('#CurrentAgencys-c').hide();
                                $('#CurrentAgencys-cc').width(190);
                            }
                            
                        }
                        else {
                            alertInfo('当前帐号没有绑定任何机构');
                            $('#toolbar-CourseSchedule').hide();
                        }
                    },
                    onSelect: function (record) {
                        buildPageByAgency();
                    }
                });

                buildPageByAgency();
            });

        //视频类型
        $('#cbxVideoType').combobox({
            width: 200,
            panelWidth: 200,
            data: null,
            valueField: 'id',
            textField: 'title',
            editable: false
        });

        //获取视频类型
        var inertfaceUrl = 'http://openapi.91stb.com:8081/api/live/main/sourceType';
        postTo(top.baseCMSInvokeUrl + "/Share/CrossDomain/GetRemoteData", $.toJSON({ RemoteUrl: inertfaceUrl, RetType: "json" }), function (result) {
            var videoContentType = eval('(' + result.ret.replace(/\r\n/g, "") + ')');
            $('#cbxVideoType').combobox('loadData', videoContentType);
        });

    });

    function buildPageByAgency() {
        //数据

        var monday = Date.today().is().monday() ? Date.today() : Date.today().moveToDayOfWeek(1, -1);
        var sunday = Date.today().moveToDayOfWeek(0);
        queryFromTo(monday, sunday);

        $('#ReserveFrom').val(Date.now().toString('HH') + ':00:00');
    }

    function queryLastWeek() {
        var beginDate = Date.parse($('#ScheduleOn_Start').val()).moveToDayOfWeek(1, -1);
        var endDate = Date.parse($('#ScheduleOn_Start').val()).moveToDayOfWeek(0, -1);
        queryFromTo(beginDate, endDate);
    }

    function queryNextWeek() {
        var beginDate = Date.parse($('#ScheduleOn_Start').val()).moveToDayOfWeek(1, 1);
        var endDate = Date.parse($('#ScheduleOn_Start').val()).moveToDayOfWeek(0, 1).addDays(7);
        queryFromTo(beginDate, endDate);
    }

    function queryFromTo(beginDate, endDate) {
        $('#ScheduleOn_Start').val(beginDate.toString('yyyy-MM-dd'));
        $('#ScheduleOn_End').val(endDate.toString('yyyy-MM-dd'));
        queryData();
    }

    function queryData() {
        var unSave = checkUnSave();
        if (unSave) {
            alertConfirm('当前还有未保存的预约信息，确定要继续吗？', function (r) {
                if (r) {
                    _queryData();
                }
            });
        }
        else {
            _queryData();
        }
    }
    function _queryData() {
        var beginDateStr = $('#ScheduleOn_Start').val();
        if (!beginDateStr) {
            alertInfo('请选择一个开始日期');
            return;
        }
        var endDateStr = $('#ScheduleOn_End').val();
        if (!endDateStr) {
            alertInfo('请选择一个结束日期');
            return;
        }

        var currentDate = Date.parse(beginDateStr);
        var days = DateDiff('d', currentDate, Date.parse(endDateStr));
        var frozenColumns = [[
                    { field: 'DeviceId', title: '设备编号', width: 150, hidden: true },
                    { field: 'DeviceName', title: '设备名称', align: 'center', width: 140, styler: function () { return 'background-color:#098AD2;color:#fff'; }, formatter: function (val) { var dName = val.toString().split("-"); if (dName.length > 2) { return dName[2]; } else { return val.toString(); } } }
            ]];
        var columns = [[]];
        for (var i = 0; i <= days; i++) {
            var spanDays = DateDiff('d', Date.today(), currentDate);
            var changeFlag = true;
            if (spanDays <= daysBeforehand) {
                changeFlag = false;
            }
            var theColumn = { changeFlag: changeFlag, field: '_' + currentDate.toString('yyyyMMdd'), title: currentDate.toString('yyyy-MM-dd') + ' (' + currentDate.getDayName() + ')', align: 'center', width: 300, formatter: serveInfoFormatter, styler: cellStyler };
            columns[0].push(theColumn);
            currentDate = currentDate.addDays(1);
        }

        $('#dg-B132002').datagrid({
            url: baseCMSInvokeUrl + '/Pam/CourseScheduleService/ListCourseSchedule',
            rownumbers: true,
            singleSelect: false,
            method: 'POST',
            autoRowHeight: false,
            queryParams: {
                instance: {
                StationId: $('#CurrentAgencys').combobox('getValue'),
                //CourseFlag:1,
                BeginDateStr: beginDateStr,
                EndDateStr: endDateStr }
            },
            loader: easyuiLoaderForStringObjectDictionary,
            frozenColumns: frozenColumns,
            columns: columns
        }).datagrid('freezeRow', 1).datagrid('attachCellSelect', {
            onmousedown: function (e) {
                if (e.button == 0 || e.button == 1) {
                    if (!e.ctrlKey) {
                        if ($('.selectedCell').size() > 0) {
                            $('.selectedCell').removeClass('selectedCell');
                        }
                    }
                    mouseClickDown = true;
                    var columnOption = $('#dg-B132002').datagrid('getColumnOption', $(this).attr('field'));
                    if (columnOption.field != '设备名称' && columnOption.changeFlag == true) {
                        $(this).addClass('selectedCell');

                    }
                }
            },
            onmouseup: function (e) {
                var userSelection;
                if (window.getSelection) { //现代浏览器
                    userSelection = window.getSelection();
                } else if (document.selection) { //IE浏览器 考虑到Opera，应该放在后面
                    userSelection = document.selection.createRange();
                }
                mouseClickDown = false;
                if (window.getSelection) {
                    if (window.getSelection().empty) {  // Chrome
                        window.getSelection().empty();
                    } else if (window.getSelection().removeAllRanges) {  // Firefox
                        try {
                            window.getSelection().removeAllRanges();
                        }
                        catch (e) { }
                    }
                } else if (document.selection) {  // IE?
                    document.selection.empty();
                }
            },
            onmouseover: function (e) {
                if (mouseClickDown) {
                    var columnOption = $('#dg-B132002').datagrid('getColumnOption', $(this).attr('field'));
                    if (columnOption && columnOption.field != '设备名称' && columnOption.changeFlag == true) {
                        $(this).addClass('selectedCell');
                    }
                }
            },
            onbodyclick: function (e) {
                if (e.target.className == 'datagrid-body') {
                    if ($('.selectedCell').size() > 0) {
                        $('.selectedCell').removeClass('selectedCell');
                    }
                }
            }
        });
    }

    function serveInfoFormatter(value, row, index) {
        var formallis = '';
        var reserveDate = this.field.substr(1);
        var columnOption = $('#dg-B132002').datagrid('getColumnOption', this.field);
        if (value) {
            formallis = _.map(value.split(','), function (o) {
                var arrServeInfo = o.split('|');
                var tmpScheduleInfo = { ScheduleId: arrServeInfo[0], BeginTime: arrServeInfo[1], EndTime: arrServeInfo[2], CourseId: arrServeInfo[3], CourseName: arrServeInfo[4], CourseDuration: arrServeInfo[5], CourseInfo: arrServeInfo[6] + "|" + arrServeInfo[7] + "|" + arrServeInfo[8], Remark: arrServeInfo[9], CourseFlag: arrServeInfo[10] };
                var color = '';
                var strPlayStatus = '—';

                var tmpBeginTime = Date.parseExact((reserveDate + " " + tmpScheduleInfo.BeginTime), 'yyyyMMdd HH:mm:ss');
                var tmpEndTime = Date.parseExact((reserveDate + " " + tmpScheduleInfo.EndTime), 'yyyyMMdd HH:mm:ss');
                var today = new Date();

                if (!columnOption.changeFlag) {
                    strPlayStatus = "已过期";
                    color = '-gray';
                }
                else if (today < tmpBeginTime) {
                    strPlayStatus = "未开始";
                    color = '-gray';
                }
                else if (today >= tmpBeginTime && today <= tmpEndTime) {
                    strPlayStatus = "进行中";
                    color = '-green';
                }
                else if (tmpEndTime < today) {
                    strPlayStatus = "已完成";
                    color = '-blue';
                }

                return replaceWithKeys(templateOfCourseInfoForView, { DisplayStyleOfRemoveServeInfoItem: columnOption.changeFlag ? 'inline-block' : 'none', ItemClickFunc: 'editScheduleItem(this,' + columnOption.changeFlag + ')', ScheduleId: tmpScheduleInfo.ScheduleId, DeviceId: row.DeviceId, ReserveDate: reserveDate, BeginTime: tmpScheduleInfo.BeginTime, EndTime: tmpScheduleInfo.EndTime, CourseName: tmpScheduleInfo.CourseName, Duration: tmpScheduleInfo.CourseDuration, ScheduleInfo: $.toJSON(tmpScheduleInfo).replace(/\"/g, "'"), CourseTypeName: (tmpScheduleInfo.CourseFlag == 3 ? '点' : '直'), Remark: tmpScheduleInfo.Remark, PlayStatus: strPlayStatus, Color: color });
            }).join("");
        }

        var htmls = [];
        htmls.push('<div class="serveInfo"><ul class="formal">' + formallis + '</ul><ul class="tmp" DeviceId="' + row.DeviceId + '" reserveDate="' + reserveDate + '"></ul></div><a title="点击保存" onclick="saveServeInfo(this,' + index + ',\'' + $(this).attr('field') + '\',\'' + value + '\')" class="saveServeInfo nicon-blue nicon-R2C16"></a>');
        if (columnOption.changeFlag) {
            htmls.push('<a title="点击预约" onclick="addServeInfo()" class="addServeInfo nicon-blue nicon-R2C11"></a>');
        }
        return htmls.join('');
    }

    function cellStyler(value, row, index) {

        if (this.title.indexOf('六') != -1 || this.title.indexOf('日') != -1) {
            return { "class": 'restday' };
        }
        else if (!this.changeFlag) {
            return { "class": 'cantchangeday' };
        }
    }

    function addServeInfo() {
        _reserve($('.selectedCell'));
    }


    function removeScheduleItem(o) {
        var $li = $(o).parent();
        var liScheduleInfo = $li.attr('scheduleInfo');
        var strReserveDate = $li.attr('reserveDate');
        var tmpScheduleInfo = eval('(' + liScheduleInfo + ')');
        var beginDate = Date.parseExact((strReserveDate + ' ' + tmpScheduleInfo.BeginTime), 'yyyyMMdd HH:mm:ss');
        var endDate = Date.parseExact((strReserveDate + ' ' + tmpScheduleInfo.EndTime), 'yyyyMMdd HH:mm:ss');
        var myDate = new Date();

        var changeFlag = true;  
        if (tmpScheduleInfo.ScheduleId && ((beginDate < myDate && endDate > myDate) || (endDate < myDate)))
        {//已安排课程并且当前课程结束时间小于当前时间 不能删除
            changeFlag = false;
        }
        if (changeFlag) {
            alertConfirm('确定要删除当前的课程信息吗？', function (r) {
                if (r) {
                    var $li = $(o).parent();
                    var $ul = $li.parent();

                    if ($ul.attr('class') == 'tmp') {
                        $li.remove();
                        if ($ul.find('li').size() == 0) {
                            $ul.parent().parent().find('.saveServeInfo').hide();
                        }
                    }
                    else if ($ul.attr('class') == 'formal') {
                        var ids = $li.attr('scheduleId');
                        deleteTo2(baseCMSInvokeUrl + '/Pam/CourseScheduleService/', ids, function () {
                            $li.remove();
                        });
                    }
                }
            });
        }
        else {
            alert('该课程已完成或者进行中，不能删除');
        }
    }

    function editScheduleItem(o, changeFlag) {
        var $li = $(o).parent();
        var scheduleId = $li.attr('scheduleId');
        var color = $li.attr('color');
        var tip_str = '';
        var doneStr = $li.attr('doneStr');
        var _height = '450';

        var strReserveDate = $li.attr('reserveDate');
        var liScheduleInfo = $li.attr('scheduleInfo');
        var tmpScheduleInfo = eval('(' + liScheduleInfo + ')');

        //时间
        var beginDate = Date.parseExact((strReserveDate + ' ' + tmpScheduleInfo.BeginTime), 'yyyyMMdd HH:mm:ss');
        var endDate = Date.parseExact((strReserveDate + ' ' + tmpScheduleInfo.EndTime), 'yyyyMMdd HH:mm:ss');
        var myDate = new Date();
        if (tmpScheduleInfo.ScheduleId && ((beginDate < myDate && endDate > myDate) || (endDate < myDate))) {
            changeFlag = false;
        }
        changeFlag ? (tip_str, _height) : (tip_str = '已完成，不能修改', _height = '495');

        $('#dlg-B132002A').dialog(_.extend({
            height: _height,
            inline: false,
            onBeforeOpen: function () {
                $('#fm-B132002A').form('clear');
                $('#fm-B132002A').form('load', tmpScheduleInfo);
                $('#SingleScheduleInfo').html(tmpScheduleInfo.CourseName);
                $('#dlgShowImg').attr('src', tmpScheduleInfo.CourseInfo.split('|')[1]);
                $('#dlgShowImg').attr('alt', tmpScheduleInfo.CourseName);

                $('#btnEditScheduleOk').show();
                if ($('#tip').length > 0) $('#tip').text();
                if (tip_str == '') {
                    //保存传入参数
                    $('#div_tip').hide();
                    $li.addClass('operat-Schedule-li'); //增加当前操作li的唯一标示
                    $('#btnEditScheduleOk').attr('operatScheduleli', 'operat-Schedule-li');
                }
                else {
                    $('#btnEditScheduleOk').hide();
                    $('#div_tip').show();
                    $('#addHtml').html('<span style="  font-weight:bolder;">' + doneStr + '</span><br /><br />'
                    + '<span id="tip" style=" color:Red; font-weight:bolder;">' + tip_str + '</span> ');
                }
            },
            modal: true
        }, null)).dialog('open').dialog('setTitle', '修改课程信息');
    }

    function editScheduleOK() {
        var formData = $('#fm-B132002A').serializeObject();

        //查找目标li
        var operatScheduleLiFlag = $('#btnEditScheduleOk').attr('operatScheduleli');
        var operatScheduleLi = $('.selectedCell ul .' + operatScheduleLiFlag)[0];
        //if (!operatScheduleLi) return;

        var nowReserveDate = $(operatScheduleLi).attr('reserveDate');
        var liScheduleInfo = $(operatScheduleLi).attr('scheduleInfo');
        var strColor = $(operatScheduleLi).attr('color');
        var doneStr = $(operatScheduleLi).attr('doneStr');
        var tmpScheduleInfo = eval('(' + liScheduleInfo + ')');

        //比较
        var change = { CourseFlag: 1 }; //默认点播模式
        var isChanged = false;
        if (!formData.CourseId) {
            alertInfo('请选择一个课程！');
            return;
        }
        if (tmpScheduleInfo.CourseId != formData.CourseId) {
            isChanged = true;
            tmpScheduleInfo.CourseId = formData.CourseId;
            tmpScheduleInfo.CourseName = formData.CourseName;
            tmpScheduleInfo.CourseDuration = formData.CourseDuration;
            tmpScheduleInfo.CourseInfo = formData.CourseInfo;

            change["CourseId"] = formData.CourseId;
            change["CourseName"] = formData.CourseName;
            change["CourseDuration"] = formData.CourseDuration;
            change["CourseInfo"] = formData.CourseInfo;
        }
        //时间
        if (!formData.BeginTime) {
            alertInfo('请输入时间！');
            return;
        }
        if (tmpScheduleInfo.BeginTime != formData.BeginTime) {
            isChanged = true;
            tmpScheduleInfo.BeginTime = formData.BeginTime;
            tmpScheduleInfo.EndTime = DateAdd('s', tmpScheduleInfo.CourseDuration, Date.parseExact(nowReserveDate + ' ' + formData.BeginTime, 'yyyyMMdd HH:mm:ss')).pattern('HH:mm:ss');

            change["BeginTime"] = toJsonDate(Date.parseExact((nowReserveDate + ' ' + formData.BeginTime), 'yyyyMMdd HH:mm:ss'));
        }
        if (tmpScheduleInfo.Remark != formData.Remark) {
            isChanged = true;
            tmpScheduleInfo.Remark = formData.Remark;

            change["Remark"] = formData.Remark;
        }

        //修改
        if (formData.ScheduleId && isChanged) {
            change["Id"] = formData.ScheduleId;

            putTo(baseCMSInvokeUrl + '/Pam/CourseScheduleService/' + change.Id, $.toJSON(change), function () {
                alertInfo('修改成功');
                $(operatScheduleLi).attr('scheduleInfo', $.toJSON(tmpScheduleInfo).replace(/\"/g, "'"));
                $(operatScheduleLi).find('.serve-info-item-fromto' + strColor).attr('title', (doneStr + '--' + tmpScheduleInfo.BeginTime + '-' + tmpScheduleInfo.EndTime)).html('[' + tmpScheduleInfo.BeginTime + ']');
                $(operatScheduleLi).find('.serve-info-item-serveman' + strColor).attr('title', (doneStr + '--课程名：' + tmpScheduleInfo.CourseName + ' 时长：[' + tmpScheduleInfo.CourseDuration + '秒]')).html('[' + tmpScheduleInfo.CourseName + '] [' + tmpScheduleInfo.CourseDuration + 'S]');

                editScheduleCancel();
            });
        }
        else {
            $(operatScheduleLi).attr('scheduleInfo', $.toJSON(tmpScheduleInfo).replace(/\"/g, "'"));
            $(operatScheduleLi).find('.serve-info-item-fromto' + strColor).attr('title', (doneStr + '--' + tmpScheduleInfo.BeginTime + '-' + tmpScheduleInfo.EndTime)).html('[' + tmpScheduleInfo.BeginTime + ']');
            $(operatScheduleLi).find('.serve-info-item-serveman' + strColor).attr('title', (doneStr + '--课程名：' + tmpScheduleInfo.CourseName + ' 时长：[' + tmpScheduleInfo.CourseDuration + '秒]')).html('[' + tmpScheduleInfo.CourseName + '] [' + tmpScheduleInfo.CourseDuration + 'S]');
            editScheduleCancel();
        }
    }

    function editScheduleCancel() {
        //移除当前操作li唯一标示
        $('.selectedCell ul .operat-Schedule-li').removeClass('operat-Schedule-li'); 

        $('#dlg-B132002A').dialog('close');
    }


    function saveServeInfo() {
        alertConfirm('确定要将选中的未确认课程信息保存吗？', function (r) {
            if (r) {
                var $lisToAdd = $('.selectedCell ul.tmp li[ScheduleId="0"]');

                var courseScheduleReserves = _.map($lisToAdd, function (li) {
                    var nowReserveDate = $(li).attr('reserveDate');
                    var liScheduleInfo = $(li).attr('scheduleInfo');
                    var liScheduleInfoJson = eval('(' + liScheduleInfo + ')');

                    var tmpScheduleInfo = { Id: -1,
                        StationId: $('#CurrentAgencys').combobox('getValue'),
                        DeviceId: $(li).attr('deviceId'),
                        BeginTime: toJsonDate(Date.parseExact((nowReserveDate + ' ' + liScheduleInfoJson.BeginTime), 'yyyyMMdd HH:mm:ss'))
                    }

                    var liScheduleInfoJson = _.extend(liScheduleInfoJson, tmpScheduleInfo);
                    return liScheduleInfoJson;
                });

                if (courseScheduleReserves.length > 0) {
                    postTo(baseCMSInvokeUrl + '/Pam/CourseScheduleService/CreateSchedule', $.toJSON(courseScheduleReserves), function (ret) {
                        if (ret.Success) {
                            _queryData();
                        }
                    });
                }
            }
        });
    }

    function updateToDB() {
        alertConfirm('确定要将所有未确认预约信息保存吗？', function (r) {
            if (r) {
                var courseScheduleReserves = _.map($('ul.tmp li'), function (li) {
                    var nowReserveDate = $(li).attr('reserveDate');
                    var liScheduleInfo = $(li).attr('scheduleInfo');
                    var liScheduleInfoJson = eval('(' + liScheduleInfo + ')');

                    var tmpScheduleInfo = { Id: -1,
                        StationId: $('#CurrentAgencys').combobox('getValue'),
                        DeviceId: $(li).attr('deviceId'),
                        BeginTime: toJsonDate(Date.parseExact((nowReserveDate + ' ' + liScheduleInfoJson.BeginTime), 'yyyyMMdd HH:mm:ss'))
                    }

                    var liScheduleInfoJson = _.extend(liScheduleInfoJson, tmpScheduleInfo);
                    return liScheduleInfoJson;
                });
                if (courseScheduleReserves.length > 0) {
                    postTo(baseCMSInvokeUrl + '/Pam/CourseScheduleService/CreateSchedule', $.toJSON(courseScheduleReserves), function (ret) {
                        if (ret.Success) {
                            alertInfo('保存成功');
                            _queryData();
                        }
                    });
                }
            }
        });
    }

    function reserve() {
        _reserve($('.selectedCell'));
    }
    var templateOfAddCourseInfoForView = '<li class="serve-info-item" scheduleId= "0"  reserveDate="[ReserveDate]" deviceId="[DeviceId]" color="[Color]"  doneStr="播放时间：[PlayStatus]" scheduleInfo="[ScheduleInfo]" ><a style="display:[DisplayStyleOfRemoveServeInfoItem]" title="删除此项" class="removeServeInfoItem actionServeInfoItem nicon-blue nicon-R2C13"></a><span title="播放时间：[PlayStatus]--[BeginTime]-[EndTime]" class="editScheduleInfoItem serve-info-item-fromto[Color]" >[[BeginTime]] </span><span title="播放时间：[PlayStatus]--课程名：[CourseName] 时长：[[Duration]秒]" class="editScheduleInfoItem serve-info-item-serveman[Color]">[[CourseName]] [[Duration]S]</span><span title="播放时间：[PlayStatus]--课程名：[CourseName] 时长：[[Duration]秒]" class="serve-info-item-serveman[Color]">[[CourseTypeName]]</span><div class="editScheduleInfoItem serve-info-item-description">[Remark]</div></li>';
    function _reserve(selectedCell) {
        var scheduleInfo = $('#BatchScheduleInfo').attr('scheduleInfo');
        if (!scheduleInfo) {
            alertInfo('请选择一个课程');
            return;
        }
        var reserveFrom = $('#ReserveFrom').val();
        var ScheduleInfo = $.parseJSON(scheduleInfo);

        var columnOption = $('#dg-B132002').datagrid('getColumnOption', selectedCell.attr('field'));
        selectedCell.find('.serveInfo').each(function () {
            //获取当前日期
            var tmpReserveDate = $(this).closest('.selectedCell').attr('field').substr(1);
            //找到当前选中的容器下所有课程信息
            var tmpArr = [];    //排序 推算是否合法时间
            var serveInfoli = $(this).find('ul li');
            tmpArr = _.map(serveInfoli, function (o) {
                var liScheduleInfo = $(o).attr('scheduleInfo');
                var tmpScheduleInfo = eval('(' + liScheduleInfo + ')');
                return tmpReserveDate + ' ' + tmpScheduleInfo.BeginTime + ',' + tmpReserveDate + ' ' + tmpScheduleInfo.EndTime;
            });
            //计划时间
            var planBeginTime = tmpReserveDate + ' ' + reserveFrom;
            var planEndTime = DateAdd('s', ScheduleInfo.CourseDuration, Date.parseExact(planBeginTime, 'yyyyMMdd HH:mm:ss')).pattern('yyyy-MM-dd HH:mm:ss').replace(/-/g, '');
            //加入计划时间并进行排序
            tmpArr.push(planBeginTime + ',' + planEndTime);
            //排序
            tmpArr = _.sortBy(tmpArr, function (i) {
                var tmpDate = i.split(",");
                return Math.max(Date.parseExact(tmpDate[0], 'yyyyMMdd HH:mm:ss'));
            });

            var canAdd = true;
            //校验
            if (tmpArr.length > 1) {
                for (var i = 0; i < tmpArr.length; i++) {
                    var nowTimeSplit = tmpArr[i].split(',');
                    if (tmpArr[i] == (planBeginTime + ',' + planEndTime)) {
                        if (i == 0) {//第一个
                            var lastTimeSplit = tmpArr[i + 1].split(',');
                            if (Date.parseExact(lastTimeSplit[0], 'yyyyMMdd HH:mm:ss') < Date.parseExact(nowTimeSplit[1], 'yyyyMMdd HH:mm:ss')) {
                                canAdd = false;
                                break;
                            }
                        }
                        else if (i == tmpArr.length - 1) { //最后一个
                            var prevTimeSplit = tmpArr[i - 1].split(',');
                            if (Date.parseExact(prevTimeSplit[1], 'yyyyMMdd HH:mm:ss') > Date.parseExact(nowTimeSplit[0], 'yyyyMMdd HH:mm:ss')) {
                                canAdd = false;
                                break;
                            }
                        }
                        else { //中间段 上个结束时间>当前开始时间 或者 下个开始时间<当前结束时间
                            var tmpprevTimeSplit = tmpArr[i - 1].split(',');
                            var tmplastTimeSplit = tmpArr[i + 1].split(',');
                            if (Date.parseExact(tmpprevTimeSplit[1], 'yyyyMMdd HH:mm:ss') > Date.parseExact(nowTimeSplit[0], 'yyyyMMdd HH:mm:ss') || Date.parseExact(tmplastTimeSplit[1], 'yyyyMMdd HH:mm:ss') < Date.parseExact(nowTimeSplit[1], 'yyyyMMdd HH:mm:ss')) {
                                canAdd = false;
                                break;
                            }
                        }
                    }
                }
            }

            if (canAdd) {
                var serveInfoContainer = $(this).find('ul.tmp');
                ScheduleInfo.BeginTime = planBeginTime.substr(9);
                ScheduleInfo.EndTime = planEndTime.substr(9);

                serveInfoContainer.append(replaceWithKeys(templateOfAddCourseInfoForView, { DisplayStyleOfRemoveServeInfoItem: columnOption.changeFlag ? 'inline-block' : 'none', DeviceId: serveInfoContainer.attr('deviceId'), ReserveDate: tmpReserveDate, BeginTime: ScheduleInfo.BeginTime, EndTime: ScheduleInfo.EndTime, CourseName: ScheduleInfo.CourseName, Duration: ScheduleInfo.CourseDuration, ScheduleInfo: $.toJSON(ScheduleInfo).replace(/\"/g, "'"), CourseTypeName: '点' , Remark: '', PlayStatus: '未开始', Color: '-gray' }));
                $.parser.parse(serveInfoContainer);

                //绑定事件-上句解析无效
                serveInfoContainer.find('.removeServeInfoItem').unbind('click').bind('click', function () { removeScheduleItem(this); });
                serveInfoContainer.find('.editScheduleInfoItem').unbind('click').bind('click', function () { editScheduleItem(this, columnOption.changeFlag); });
            }
            else {
                $(this).closest('.selectedCell').removeClass('selectedCell')
            }
        }).end().find('.saveServeInfo').each(function () {
            if ($(this).prev().find('.tmp li').length > 0) {
                $(this).show();
            }
        }).end().focus();
    }

    function undo() {
        $('.serveInfo ~ .saveServeInfo').each(function () {
            if (!$(this).is(':hidden')) {
                $(this).hide().parent().find('ul.tmp').empty();
            }
        });
    }

    function checkUnSave() {
        var ret = false;
        $('.serveInfo ~ .saveServeInfo').each(function () {
            if (!$(this).is(':hidden')) {
                ret = true;
            }
        });
        return ret;
    }


    //打开图片对话框
    function openVideoInfo(strVideoLocation) {
        $('#dlg-B132002AA #btnVideoOk').attr('VideoLocation', strVideoLocation);

        $('#dlg-B132002AA').dialog(_.extend({
            toolbar: '#toolbar-B132002AA',
            inline: false,
            onBeforeOpen: function () {
                videoContentToHtml();
            },
            modal: true
        }, null)).dialog('open').dialog('setTitle', '筛选-课程');
    }

    //过滤视频
    function dlgVideoSearch() {
        var typeId = $('#cbxVideoType').combobox('getValue');
        videoContentToHtml(typeId);
    }

    //转换-展示图片
    function videoContentToHtml(typeId) {
        //清空
        $('#video-content').html('');

        var inertfaceUrl = 'http://openapi.91stb.com:8081/api/live/main/source';
        if (typeId) {
            inertfaceUrl += '?typeid=' + typeId;
        }

        postTo(top.baseCMSInvokeUrl + "/Share/CrossDomain/GetRemoteData", $.toJSON({ RemoteUrl: inertfaceUrl, RetType: "json" }), function (result) {
            videoContent = eval('(' + result.ret.replace(/\r\n/g, "") + ')');

            var strDate = (new Date()).pattern('yyyy-MM-dd');    //日期-辅助计算时长
            var defaultBeginDate = Date.parseExact(strDate + ' 00:00:00', 'yyyy-MM-dd HH:mm:ss');

            var html = _.map(videoContent, function (o) {
                var htm = _.map(o.list, function (i) {
                    var tmphtm = [];
                    tmphtm.push("<div class='livecourse-mot-head'><a href='javascript:void(0)' title='" + i.title + "' style='color:#fff;font-size:14px;' >" + i.title.substr(0, 20) + "</a></div>");
                    tmphtm.push("<div class='livecourse-mot-body'><img style='height:100%;width:100%;' alt='" + i.title + "' src='" + i.cover + "' /></div>");
                    tmphtm.push("<div class='livecourse-mot-foot'><a title='选中' class='alink nicon-blue nicon-R2C14' style='width:10%;'></a><span style='text-align:center;'>大小:" + i.size + "&nbsp;&nbsp;时长:" + i.duration + "</span></div>");
                    //获取视频时长单位S
                    var videoDuration = DateDiff('s', defaultBeginDate, Date.parseExact(strDate + ' ' + i.duration, 'yyyy-MM-dd HH:mm:ss'));
                    return "<li class='livecourse-mot' scheduleInfo='" + $.toJSON({ CourseType: o.type_name, CourseId: i.id, CourseName: i.title, CourseDuration: videoDuration, CourseFlag: 3, CourseInfo: i.size + "|" + i.cover + "|" + i.vod_url }) + "'>" + tmphtm.join("") + "</li>";
                });

                var _height = 60;
                if ((htm.length / 4) > 0) {
                    _height = (parseInt(htm.length / 4) + 1) * 215 + 50;
                }

                return "<div style='min-height:" + _height + "px' class='livecourse-block'><div class='livecourse-title'>" + o.type_name + "</div><ul>" + htm.join("") + "</ul></div>"; ;
            });
            $('#video-content').html(html.join(""));

            $('#video-content ul li').mouseover(function () {
                $(this).css("border-color", '#FF0000');
            }).mouseout(function () {
                $(this).css("border-color", '#006699');
            }).click(function () {
                $('#video-content ul li').removeClass('tmpselect').find('.alink').hide();
                $(this).addClass('tmpselect').find('.alink').css('display', 'inline-block');
            });
        });
    }


    //关闭查询窗口
    function dlgVideoOk() {
        var tmpCourse = $('#video-content .tmpselect').length;
        if (tmpCourse == 0) {
            alertConfirm('确定不选择课程,直接关闭吗?', function (r) {
                if (r) {
                    dlgVideoCancel();
                }
            });
        }
        else {
            var strVideoLocation = $('#dlg-B132002AA #btnVideoOk').attr('VideoLocation');   //显出位置

            var courseInfo = $.parseJSON($('#video-content .tmpselect').attr("scheduleInfo"));
            if (strVideoLocation == 'batch') {
                $('#BatchScheduleInfo').attr('scheduleInfo', $.toJSON(courseInfo)).html(courseInfo.CourseType + "[" + courseInfo.CourseName + "]");
            }
            else {
                $('#fm-B132002A #SingleScheduleInfo').html("");
                //$('#fm-B132002A').form('clear');
                $('#fm-B132002A').form('load', courseInfo);
                $('#fm-B132002A #SingleScheduleInfo').html(courseInfo.CourseType + "[" + courseInfo.CourseName + "]");
                $('#fm-B132002A #dlgShowImg').attr('src', courseInfo.CourseInfo.split('|')[1]);
            }

            dlgVideoCancel();
        }
    }

    function dlgVideoCancel() {
        $('#dlg-B132002AA').dialog('close');
    }


    //拷贝课程信息
    function CopyCourseSchedule() {
        var rows = $('#dg-B132002').datagrid('getRows');
        var deviceIds = _.map(rows, function (o) {
            return { DeviceId: o.DeviceId, DeviceName: (o.DeviceName.split('-').length > 2 ? (o.DeviceName.split('-')[2]) : o.DeviceName) };
        });

        $('#dlg-CopyCourseSchedule').dialog(_.extend({
            onBeforeOpen: function () {
                var startDay = Date.today();
                var endDay = Date.today().add(6).days();
                $('#CopyFrom_Start').val(startDay.toString('yyyy-MM-dd'));
                $('#CopyFrom_End').val(endDay.toString('yyyy-MM-dd'));

                $('#CopyTo_Start').val(endDay.add(1).days().toString('yyyy-MM-dd'));
                $('#CopyTo_End').val(endDay.add(6).days().toString('yyyy-MM-dd'));

                $('#checkCopyDeviceAll').prop('checked', false);

                var htmls = _.map(deviceIds, function (o, i) {
                    var strHtm = '';
                    if (parseInt(i % 2) == 0) {
                        strHtm += '<tr style="height:30px; width:100%;">';
                    }
                    strHtm += '<td style="text-align:center; width:10%; "><input type="checkbox" id="copy_' + o.DeviceId + '"  onclick="checkOne(\'copyDeviceIdList\',\'checkCopyDeviceAll\')"/></td><td style="  text-align:left; width:40%;"><label for="copy_' + o.DeviceId + '">' + o.DeviceName + '</label></td>';
                    if (i > 0 && parseInt(i / 2) == 0) {
                        strHtm += '</tr>';
                    }

                    return strHtm;
                });
                $('#copyDeviceIdList').html(htmls.join(''));
            },
            modal: true
        }, null)).dialog('open').dialog('setTitle', '复制-课程');
    }

    //拷贝保存
    function dlgCopyOK() {
        var stationId = $('#CurrentAgencys').combobox('getValue');

        var deviceIds = _.map($('#copyDeviceIdList input:checkbox:checked'), function (o) {
            return $(o).attr('Id').split('_')[1];
        });

        if (deviceIds && deviceIds.length>0) {
            var tmpDate = $('#CopyFrom_Start').val();
            if (!tmpDate) {
                alertInfo('起始段时间不能为空!');
                return;
            }
            tmpDate = $('#CopyFrom_End').val();
            if (!tmpDate) {
                alertInfo('起始段时间不能为空!');
                return;
            }
            tmpDate = $('#CopyTo_Start').val();
            if (!tmpDate) {
                alertInfo('目标段时间不能为空!');
                return;
            }
            tmpDate = $('#CopyTo_End').val();
            if (!tmpDate) {
                alertInfo('目标段时间不能为空!');
                return;
            }

            var formData = { StationId: stationId,
                CopyType: 3,
                DeviceIds: deviceIds.join('|'),
                CopyFrom_Start: $('#CopyFrom_Start').val() + ' 00:00:00',
                CopyFrom_End: $('#CopyFrom_End').val() + ' 23:59:59',
                CopyTo_Start: $('#CopyTo_Start').val() + ' 00:00:00',
                CopyTo_End: $('#CopyTo_End').val() + ' 23:59:59'
            }

            postTo(baseCMSInvokeUrl + '/Pam/CourseScheduleService/CopyCourceSchedule', $.toJSON(formData), function (ret) {
                if (ret.Success) {
                    alert('复制成功');
                    queryFromTo($('#CopyTo_Start').val(), $('#CopyTo_End').val());
                    dlgCopyCancel();
                }
            });
        }
        else {
            alert('请选择复制对象!');
        }
    }

    //关闭拷贝窗口
    function dlgCopyCancel() {
        $('#dlg-CopyCourseSchedule').dialog('close');
    }

    //推送课程信息
    function PushCourseSchedule() {
        var rows = $('#dg-B132002').datagrid('getRows');
        var deviceIds = _.map(rows, function (o) {
            return { DeviceId: o.DeviceId, DeviceCode:o.DeviceCode.split('-')[2] ,DeviceName: (o.DeviceName.split('-').length > 2 ? (o.DeviceName.split('-')[2]) : o.DeviceName) };
        });
        
        $('#dlg-PushCourseSchedule').dialog(_.extend({
            onBeforeOpen: function () {
                var startDay = Date.today();
                var endDay = Date.today().add(6).days();
                $('#PushDate_Start').val(startDay.toString('yyyy-MM-dd'));
                $('#PushDate_End').val(endDay.toString('yyyy-MM-dd'));

                $('#checkPushDeviceAll').prop('checked', false);

                var htmls = _.map(deviceIds, function (o, i) {
                    var strHtm = '';
                    if (parseInt(i % 2) == 0) {
                        strHtm += '<tr style="height:30px; width:100%;">';
                    }
                    strHtm += '<td style="text-align:center; width:10%; "><input type="checkbox" deviceCode="' + o.DeviceCode + '" id="push_' + o.DeviceId + '"  onclick="checkOne(\'pushDeviceIdList\',\'checkPushDeviceAll\')"/></td><td style="  text-align:left; width:40%;"><label for="push_' + o.DeviceId + '">' + o.DeviceName + '</label></td>';
                    if (i > 0 && parseInt(i / 2) == 0) {
                        strHtm += '</tr>';
                    }

                    return strHtm;
                });
                $('#pushDeviceIdList').html(htmls.join(''));
            },
            modal: true
        }, null)).dialog('open').dialog('setTitle', '推送-课程');
        
    }
    //推送
    function dlgPushOK() {
        var stationId = $('#CurrentAgencys').combobox('getValue');

        var deviceIds = _.map($('#pushDeviceIdList input:checkbox:checked'), function (o) {
            return $(o).attr('Id').split('_')[1];
        });

        if (deviceIds && deviceIds.length > 0) {
            var pushDateStart = $('#PushDate_Start').val();
            if (!pushDateStart) {
                alertInfo('开始时间不能为空!');
                return;
            }
            var pushDateEnd = $('#PushDate_End').val();
            if (!pushDateEnd) {
                alertInfo('结束时间不能为空!');
                return;
            }

            var pushData = { RemoteUrl: 'http://openapi.91stb.com:8081/api/video/upload/live',
                StationId: stationId, DeviceIds: deviceIds.join(","),
                CourseBeginTime: toJsonDate(Date.parseExact((pushDateStart + ' 00:00:00'), 'yyyy-MM-dd HH:mm:ss')),
                CourseEndTime: toJsonDate(Date.parseExact((pushDateEnd + ' 00:00:00'), 'yyyy-MM-dd HH:mm:ss'))
            }
            postTo(top.baseCMSInvokeUrl + "/Share/CrossDomain/PushJuDouCourse", $.toJSON(pushData), function (ret) {
                if (ret.Success) {
                    alertInfo("发送成功!");
                    dlgPushCancel();
                }
            });
        }
        else { 
            alertInfo("请选择要推送的设备!")
        }
    }
    //关闭推送窗口
    function dlgPushCancel() {
        $('#dlg-PushCourseSchedule').dialog('close');
    }

    function moveWeek(strTypeId, strFlag) {
        var iday = strFlag == 'Prev' ? -7 : 7;

        var strStartDate = $('#' + strTypeId + '_Start').val();
        var strEndDate = $('#' + strTypeId + '_End').val();

        if (strTypeId == "CopyTo" && strFlag == 'Prev') {
            var tmpEndDate = $('#CopyFrom_End').val();
            if (DateDiff('d', Date.parse(tmpEndDate), Date.parse(strStartDate)) <= 1) {
                return;
            }
        }

        $('#' + strTypeId + '_Start').val(Date.parse(strStartDate).add(iday).days().toString('yyyy-MM-dd'));
        $('#' + strTypeId + '_End').val(Date.parse(strEndDate).add(iday).days().toString('yyyy-MM-dd'));
    }
    //单选
    function checkOne(iflag, icheck) {
        alert(iflag);
        alert(icheck);
        if ($('#' + iflag + ' input:checkbox:checked').size() == 0) {
            $('#' + icheck).prop('checked', false);
        }
        else {
            $('#' + icheck).prop('checked', true);
        }
    }

    //全选/全不选
    function checkAll(o, iflag) {
        var bChk = $(o).attr('checked') ? true : false;
        $('#' + iflag + ' input:checkbox').prop('checked', bChk);
    }
</script>
